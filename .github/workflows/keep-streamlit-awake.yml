name: Keep Streamlit App Awake

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  wakeup:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Create wakeup.js file
        run: |
          echo "const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();
            await page.goto('https://homefinder-tampa.streamlit.app/', {
              waitUntil: 'networkidle2',
              timeout: 0
            });

            try {
              await page.waitForSelector('button', { timeout: 10000 });
              const buttonText = await page.evaluate(() => {
                const btn = document.querySelector('button');
                return btn?.innerText || '';
              });

              if (buttonText.includes('Yes, get this app back up')) {
                console.log('ðŸ’¤ App is sleeping. Waking it up...');
                await page.click('button');
                await page.waitForTimeout(10000); // Wait for the app to fully load
              } else {
                console.log('âœ… App is already awake.');
              }
            } catch (e) {
              console.log('ðŸ›‘ No button found. Assuming app is already active.');
            }

            await browser.close();
          })();" > wakeup.js

      - name: Run Wake Up Script
        run: node wakeup.js
